---
title: "RUE Fodder Beet"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(lubridate)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)

```

## Read and clean data

```{r Read, include=TRUE, echo=FALSE}

fileFolder <- "C:\\GitHubRepos\\FodderBeetRUE_2016\\"

info <- read.table(paste0(fileFolder, "RUE.txt"), header = TRUE)

str(info)

info$N_Treatments <- as.factor(info$N_Treatments)
info$Date <- dmy(info$Date )
info$Total_DM <- info$Total_DM*100 # kg/ha to g/m2

summary(info)

```

```{r, echo=FALSE}
head(info)
```


```{r TimeSeries, echo=FALSE, warning=FALSE,fig.height=8, fig.width=8}

info %>%
 # dplyr::select(-Shoot_DM, -Bulb_DM) %>%
  tidyr::gather("Variable", "Value",11:12) %>%
  mutate(Variable = as.factor(Variable))  %>%
  group_by(Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential, Date, Variable) %>%
  summarise_each(funs(mean, sd)) %>%
  mutate(Variable = factor(Variable, levels=c("Total_DM", "Interception"))) %>%
  ggplot(aes(x=Date,y=Value_mean, 
             shape=factor(N_Treatments),
             colour=factor(Water_treat_level))) +
  geom_point() +
  geom_line() +
  facet_grid(Variable~Experiment, scales= "free") +
  ylab("Intercepted light (MJ/m2) Total biomass (g/m2)") +
  xlab("Sampling date") +
  geom_errorbar(aes(ymin=Value_mean-Value_sd/2,
                    ymax=Value_mean+Value_sd/2), 
                width=0.25) +
  theme(legend.title=element_blank(),strip.text.y = element_blank())
  
  
```

## Including Plots

```{r N_effect, echo=FALSE, warning=FALSE,fig.height=8, fig.width=8}

# biomass
info %>%
  filter(Stage == "final") %>%
  group_by(Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  summarise_each(funs(mean, sd)) %>%
  mutate(Potential = factor(Potential, levels=c("Potential", "Limited"))) %>%
  ggplot(aes(x=N_Treatments,y=Total_DM_mean, 
             shape=factor(Water_Treatments),
             colour=factor(Water_treat_level))) +
  geom_point() +
  ylab("Total biomass (g/m2) ") +
  xlab(" N rate (kg N/ha)") +
  geom_errorbar(aes(ymin=Total_DM_mean-Total_DM_sd/2,
                    ymax=Total_DM_mean+Total_DM_sd/2), 
                width=0.25) +
 # facet_wrap(Experiment~Potential, ncol=3)
   facet_grid(Potential~Experiment) +
  theme(legend.title=element_blank())



```

```{r, warning=FALSE,fig.height=8, fig.width=8}
# light interception
info %>%
  filter(Stage == "final") %>%
  group_by(Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  summarise_each(funs(mean, sd)) %>%
  mutate(Potential = factor(Potential, levels=c("Potential", "Limited"))) %>%
  ggplot(aes(x=N_Treatments,y=Interception_mean, 
             shape=factor(Water_Treatments),
             colour=factor(Water_treat_level))) +
  geom_point() +
  ylab("Intercepted light (MJ/m2) ") +
  xlab(" N rate (kg N/ha)") +
  geom_errorbar(aes(ymin=Interception_mean-Interception_sd/2,
                    ymax=Interception_mean+Interception_sd/2), 
                width=0.25) +
 # facet_wrap(Experiment~Potential, ncol=3)
   facet_grid(Potential~Experiment)+
  theme(legend.title=element_blank())
```

- RUE is estimated between first and last harvest
- Not forcing to zero due to potential bias
- First biomass harvest is at very high interception (biased overestimation of RUE?)

```{r pressure, echo=FALSE, echo=FALSE, warning=FALSE,fig.height=8, fig.width=8}

info %>%
 # dplyr::select(Date, N_Treatments, Water_Treatments,Total_DM,Interception)  %>%
  group_by(Experiment, N_Treatments, Water_Treatments,Water_treat_level,Date, Potential) %>%
  mutate(Total_DM = Total_DM) %>% # from t/ha to g/m2
  summarise_each(funs(mean,sd)) %>%
   mutate(Potential = factor(Potential, levels=c("Potential", "Limited"))) %>%
  ggplot(aes(x=Interception_mean,y=Total_DM_mean, 
             shape=factor(N_Treatments),
             colour=factor(Water_treat_level))) +
  geom_point() +
  geom_smooth(method=lm, se=FALSE) +
  ylab("Total biomass (g/m2) ") +
  xlab(" Light interception (MJ/m2)") +
    geom_errorbar(aes(ymin=Total_DM_mean-Total_DM_sd/2,
                    ymax=Total_DM_mean+Total_DM_sd/2)) +
 # facet_wrap(~N_Treatments, ncol=3)
 facet_grid(Potential~Experiment) +
  theme(legend.title=element_blank())


```


```{r RUECalc, echo=FALSE, warning=FALSE, include=TRUE,fig.height=8, fig.width=8}

# calculate RUE per plot

# head(info)

# create index for each rep (observation period and unit as a rueChunk)
info <- info %>%
mutate(rueChunk = paste0(Experiment,"_", 
                         N_Treatments,"_" ,
                         Water_treat_level,"_", 
                         Rep))

rounds <- unique(info$rueChunk)

# loop through all the individual periods/treats/experiments
resTable <- data.frame(NULL)

for(i in 1:length(rounds)) {
  
 thisStat <- NULL
  
 buf <- info[info$rueChunk == rounds[i],]
 
 y_int <- buf$Total_DM 
 x_bio  <- buf$Interception
  
  n_s <- length(x_bio)
  n_m <- length(y_int)
  model <- lm(y_int~x_bio)
  x_bio_sq <- sum((x_bio - mean(x_bio))^2)
  mes_sq <- sum((y_int - mean(y_int))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]
  slope_sig <- summary(model)$coefficients[8]
  int <- model$coefficients[[1]]
  int_sig <- summary(model)$coefficients[7]
  bio_max <- max(y_int)
  light_max <- max(x_bio)  
  
 thisStat <- data.frame(Exp = buf$Experiment[1], 
                        N_treat = buf$N_Treatments[1], 
                        W_treat = buf$Water_Treatments[1],
                        W_treat_lev = buf$Water_treat_level[1],
                        Rep = buf$Rep[1],
                        n = n_s,
                        RUE = slope, 
                        slope_dif_zero = round(slope_sig,digits=3),
                        intercept=int,
                        int_dif_zero = int_sig,
                        bio_max = bio_max,
                        light_max = light_max,
                        R2=r2)
 
 if(i==1) {
   resTable <- thisStat
 } else {
   resTable <- rbind(resTable,thisStat)
 }
}

resTable$Rep <- as.factor(resTable$Rep)
head(resTable)


# colnames(resTable) <- c("Experiment","N_Treatments", 
#                         "Water_Treatments", "Rep",
#                         "RUE", "Intercept", "R2")


```

```{r, echo=FALSE,fig.height=8, fig.width=8}
summary(resTable)
```

## Check all RUE estimates

```{r,fig.height=8, fig.width=8}
resTable %>%
  ggplot(aes(x=N_treat, y=RUE, colour=W_treat)) +
  geom_point() +
  facet_grid(.~Exp)
```

```{r}
resTable %>%
  kable(format = "markdown", digits = 2)
```

```{r, warning=FALSE,fig.height=8, fig.width=8}

x <- resTable %>%
  group_by(Exp, N_treat, W_treat) %>%
  summarise_each(funs(mean, sd))


# graph
resTable %>%
  group_by(Exp, N_treat, W_treat) %>%
  dplyr::select(RUE) %>%
  summarise_each(funs(mean, sd)) %>%
  ggplot(aes(x=N_treat, y=as.numeric(mean),
             shape=factor(W_treat),
             colour=factor(W_treat))) +
  geom_point(size = 2) +
  geom_line() +
  facet_grid(.~Exp) +
  ylab("Radiation use efficiency (g/MJ) ") +
  xlab(" N rate (kg N/ha)")+
    geom_errorbar(aes(ymin=mean-sd/2,
                    ymax=mean+sd/2), width = 0.25) 

```

```{r NormRUE}
# normalise within each experiment
rue_norm <- resTable %>%
  group_by(Exp) %>% # FIXME: not sure how to select the maximum here. Assuming it's treat
  mutate(RUEmax = max(RUE)) %>%
  ungroup() %>%
  mutate(RUEnorm = RUE/RUEmax) 

head(rue_norm)
```


```{r, warning=FALSE}
rue_norm %>%
#  mutate(N_treat_num = as.numeric(as.character(N_treat))) %>%
  filter(Exp != "C") %>% # no N response in exp C
  group_by(Exp, N_treat, W_treat,W_treat_lev) %>%
  summarise_each(funs(mean, sd)) %>%
  ggplot(aes(x=as.numeric(as.character(N_treat)), y=as.numeric(RUEnorm_mean),
             colour=factor(W_treat))) +
  geom_point(aes(shape=factor(Exp)),size = 4) +
 # geom_line() +
  geom_smooth(aes(colour=factor(W_treat)),se = FALSE, method="lm") +
  ylab("Normalised radiation use efficiency (0-1) ") +
  xlab(" N rate (kg N/ha)")+
    geom_errorbar(aes(ymin=RUEnorm_mean-RUEnorm_sd/2,
                    ymax=RUEnorm_mean+RUEnorm_sd/2), width = 0.25) +
  ylim(0.5, 1)
```

```{r SaveRUE}
write.csv(rue_norm,"RUE_Estimated_FodderBeet.csv" )
```

## ANOVA RUE

- not tested yet

```{r ANOVA, echo=FALSE}

str(resTable)

exp <- unique(resTable$Exp)


for(e in 1:length(exp)) {
  
  if(e == 1) {
    
anova <- NULL
df <- NULL
df <- resTable %>% subset(Exp == exp[e])

anova <- aov(RUE ~ N_treat+Rep, data = df)
print("############## EXP A ##############")
print(" ")
print(summary(anova))
print(TukeyHSD(anova))

    
  } else if ( e == 2) {
    
anova <- NULL
df <- NULL
df <- resTable %>% subset(Exp == exp[e])
 
  
anova <- aov(RUE ~ N_treat*W_treat_lev+Rep, data = df)
print("############## EXP B ##############")
print(" ")
print(summary(anova))
print(TukeyHSD(anova))
    
  }  else if (e == 3) {
    
anova <- NULL
df <- NULL
df <- resTable %>% subset(Exp == exp[e])

anova <- aov(RUE ~ W_treat_lev+Rep, data = df)
print("############## EXP C ##############")
print(" ")
print(summary(anova))
print(TukeyHSD(anova))
    
  }
  
}

```


