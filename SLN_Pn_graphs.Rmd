---
title: "Untitled"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lubridate)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(segmented)

```

```{r Read}
fileFolder <- "C:\\GitHubRepos\\FodderBeetRUE_2016\\"

info <- read.table(paste0(fileFolder, "RUE.txt"), header = TRUE)

str(info)

info$N_Treatments <- as.factor(info$N_Treatments)
# as.Date(info$Date, "%m/%d/%Y")
info$Date <- dmy(info$Date) # FIXME: Had some problems not parsing this format - not sure why
info$Total_DM <- info$Total_DM*100 # kg/ha to g/m2

summary(info)

str(info$Date)
```


## Test SLN vs Pn

- raw data all points

```{r, fig.height=8, fig.width=8}

info %>%
  ggplot(aes(x=SLN, y=Pn, colour=N_Treatments))+
  geom_point(aes(shape=Water_treat_level)) + 
  facet_grid(.~Water_Treatments)

```

## Normalise Pn values

- Find maximum by Experiment and Date
- Average values by N treatment
- Calculate normalised Pn by N treatment in relation to maximum Pn by treatment (rationale: instantaneous wheather conditions vary too much and affect Pn ... therefore better reduce noise using relative values)



```{r NormalisePn}

# maximum Pn of a given day and treatmnet
df_Pn_max <- info %>%
  na.omit() %>%
  group_by(Experiment, Date) %>%
  summarise(Pn_max = max(Pn)) 

head(df_Pn_max)

```

```{r}
# merge it with original
df_Pn_norm <- merge(info, df_Pn_max, by = c("Experiment", "Date"))
```

```{r}
summary(df_Pn_norm)
```

## Plot absolute values

```{r, fig.height=8, fig.width=8}
# plot
df_Pn_norm %>%
 # filter(Stage == "final") %>%
 # filter(Water_Treatments == "Irrigated") %>%
  mutate(Pn_norm = Pn/Pn_max) %>%
  group_by(Date, Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  dplyr::select(SLN, Pn_norm, Pn) %>%
  na.omit() %>%
  summarise_each(funs(mean, sd)) %>%
#  tidyr::gather("Variable","Value",SLN_mean:Pn_sd) %>%
  ggplot(aes(x=SLN_mean , y=Pn_mean)) +
  geom_point(aes(colour=N_Treatments, shape=Water_treat_level)) +
    geom_errorbar(aes(ymin=Pn_mean-Pn_sd/2,
                    ymax=Pn_mean+Pn_sd/2), width = 0.0, colour = "darkgrey") +
    geom_errorbarh(aes(xmin=SLN_mean-SLN_sd/2,
                    xmax=SLN_mean+SLN_sd/2), colour = "darkgrey")+
  ylab("Photosynthetic rate (umol/m2/s)") +
  xlab("Specific Leaf Nitrogen (SLN)") +
  theme(legend.title=element_blank())
```

## Plot normalised values

```{r, fig.height=8, fig.width=8}

# plot
df_Pn_norm %>%
  mutate(Pn_norm = Pn/Pn_max*100) %>%
  group_by(Date, Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  dplyr::select(SLN, Pn_norm, Pn) %>%
  na.omit() %>%
  summarise_each(funs(mean, sd)) %>%
  ggplot(aes(x=SLN_mean , y=Pn_norm_mean)) +
  geom_point(aes(colour=N_Treatments, shape=Water_treat_level)) +
    geom_errorbar(aes(ymin=Pn_norm_mean-Pn_norm_sd/2,
                    ymax=Pn_norm_mean+Pn_norm_sd/2), width = 0.0, colour = "darkgrey") +
    geom_errorbarh(aes(xmin=SLN_mean-SLN_sd/2,
                    xmax=SLN_mean+SLN_sd/2), colour = "darkgrey")+
  ylab("Normalised Photosynthetic rate (% maximum)") +
  xlab("Specific Leaf Nitrogen (SLN)") +
  theme(legend.title=element_blank())
```

## Cluster analysis

```{r Cluster}


# Used this method: http://rstudio-pubs-static.s3.amazonaws.com/2598_ccd642fc32854463844c6f9cc153983a.html

# This is also good: http://www.statmethods.net/advstats/cluster.html

# select data
mydata <- df_Pn_norm %>% 
  na.omit() %>%
  dplyr::select(Pn,SLN) # %>%
#  scale()

head(mydata)



```

```{r}
#plot data
mydata %>%
  ggplot(aes(x=SLN, y=Pn)) +
  geom_point()
```

```{r, include=FALSE}
# cluster with 1 to 10 cluster
res.kmeans <- lapply(1:10, function(i) {
    kmeans(mydata[,c("SLN","Pn")], centers = i)
})

## SS for each cluster (1 cluster to 10 clusters)
lapply(res.kmeans, function(x) x$withinss)

## Sum up SS
res.within.ss <- sapply(res.kmeans, function(x) sum(x$withinss))
```

# PLot cluster number and within cluster sums of squares

```{r, fig.height=8, fig.width=8}
#plot
ggplot(data.frame(cluster = 1:10, within.ss = res.within.ss), aes(cluster, within.ss)) +
    geom_point() + geom_line() +
    scale_x_continuous(breaks = 0:10)
```

## Check all clusters in graph

```{r, include=FALSE, echo=FALSE}
# colour cluster
cluster.colors <- lapply(res.kmeans, function(x) x$cluster)

# loop on graphs
lapply(cluster.colors,
      function(colors) {
          plot.dat <- cbind(mydata, cluster = factor(colors))

          gg.obj <- ggplot(plot.dat, aes(SLN, Pn, color = cluster)) +
              geom_point() + labs(title = paste(nlevels(factor(colors))))

          print(gg.obj)
      })

```

## Plot graph for selected cluster number

```{r, fig.height=8, fig.width=8}

colour.selected <- cluster.colors[[5]]

col.func <- function(colors) {
          plot.dat <- cbind(mydata, cluster = factor(colors))

          gg.obj <- ggplot(plot.dat, aes(SLN, Pn, color = cluster)) +
              geom_point() + labs(title = paste(nlevels(factor(colors))))

          print(gg.obj) 
}

col.func(colour.selected)


```

