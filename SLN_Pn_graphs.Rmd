---
title: "Untitled"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lubridate)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(segmented)

```

```{r Read}
fileFolder <- "C:\\GitHubRepos\\FodderBeetRUE_2016\\"

info <- read.table(paste0(fileFolder, "RUE.txt"), header = TRUE)

str(info)

info$N_Treatments <- as.factor(info$N_Treatments)
info$Date <- dmy(info$Date )
info$Total_DM <- info$Total_DM*100 # kg/ha to g/m2

summary(info)
```


## Test SLN vs Pn

- raw data all points

```{r}

info %>%
  ggplot(aes(x=SLN, y=Pn, colour=N_Treatments))+
  geom_point(aes(shape=Water_treat_level)) + 
  facet_grid(.~Water_Treatments)

```

## Normalise Pn values

- Find maximum by Experiment and Date
- Average values by N treatment
- Calculate normalised Pn by N treatment in relation to maximum Pn by treatment (rationale: instantaneous wheather conditions vary too much and affect Pn ... therefore better reduce noise using relative values)



```{r NormalisePn}

# maximum Pn of a given day and treatmnet
df_Pn_max <- info %>%
  na.omit() %>%
  group_by(Experiment, Date) %>%
  summarise(Pn_max = max(Pn)) 

head(df_Pn_max)

# merge it with original
df_Pn_norm <- merge(info, df_Pn_max, by = c("Experiment", "Date"))

```

```{r}
summary(df_Pn_norm)
```

## Plot absolute values

```{r}
# plot
df_Pn_norm %>%
 # filter(Stage == "final") %>%
 # filter(Water_Treatments == "Irrigated") %>%
  mutate(Pn_norm = Pn/Pn_max) %>%
  group_by(Date, Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  dplyr::select(SLN, Pn_norm, Pn) %>%
  na.omit() %>%
  summarise_each(funs(mean, sd)) %>%
#  tidyr::gather("Variable","Value",SLN_mean:Pn_sd) %>%
  ggplot(aes(x=SLN_mean , y=Pn_mean)) +
  geom_point(aes(colour=N_Treatments, shape=Water_treat_level)) +
    geom_errorbar(aes(ymin=Pn_mean-Pn_sd/2,
                    ymax=Pn_mean+Pn_sd/2), width = 0.0, colour = "darkgrey") +
    geom_errorbarh(aes(xmin=SLN_mean-SLN_sd/2,
                    xmax=SLN_mean+SLN_sd/2), colour = "darkgrey")+
  ylab("Photosynthetic rate (umol/m2/s)") +
  xlab("Specific Leaf Nitrogen (SLN)") +
  theme(legend.title=element_blank())
```

## Plot normalised values

```{r}

# cluster

  
# plot
df_Pn_norm %>%
  mutate(Pn_norm = Pn/Pn_max*100) %>%
  group_by(Date, Experiment, N_Treatments, Water_Treatments, Water_treat_level, Potential) %>%
  dplyr::select(SLN, Pn_norm, Pn) %>%
  na.omit() %>%
  summarise_each(funs(mean, sd)) %>%
  ggplot(aes(x=SLN_mean , y=Pn_norm_mean)) +
  geom_point(aes(colour=N_Treatments, shape=Water_treat_level)) +
    geom_errorbar(aes(ymin=Pn_norm_mean-Pn_norm_sd/2,
                    ymax=Pn_norm_mean+Pn_norm_sd/2), width = 0.0, colour = "darkgrey") +
    geom_errorbarh(aes(xmin=SLN_mean-SLN_sd/2,
                    xmax=SLN_mean+SLN_sd/2), colour = "darkgrey")+
  ylab("Normalised Photosynthetic rate (% maximum)") +
  xlab("Specific Leaf Nitrogen (SLN)") +
  theme(legend.title=element_blank())
```

```{r}
# df_Pn_norm %>%
#   kable(format = "markdown", digits = 2)
```


```{r Pn_norm_graph}

# df_Pn_norm %>%
#   ggplot(aes(x=SLN, y=Pn_norm, colour=N_Treatments)) +
#   geom_segment(aes(x = min(SLN), xend = b, y = 0.84, yend = 1), 
#                linetype=1, colour ="black", size=1.2) +
#   geom_segment(aes(x = b, xend = max(SLN), y = 1, yend = 1), linetype=1, colour ="black", size=1.2) +
#   geom_point(aes(shape=Experiment)) +
#   geom_errorbar(aes(ymin=Pn_norm-Pn_sd_norm/2,
#                     ymax=Pn_norm+Pn_sd_norm/2)) +
#  # facet_grid(.~Experiment) +
#   geom_errorbarh(aes(xmin = SLN-SLN_sd/2,
#                      xmax = SLN+SLN_sd/2)) +
#   xlab("Specific Leaf Nitrogen (SLN, g N/cm2)") +
#   ylab("Normalised maximum\n photosynthetic rate (fractional)")

```

